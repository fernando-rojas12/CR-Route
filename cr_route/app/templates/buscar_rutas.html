{% extends "base.html" %}
{% load static %}

{% block title %}
Buscar rutas
{% endblock title %}


{% block mainContent %}
<div class="container">
    <div class="row justify-content-center">

        <!-- COLUMNA IZQUIERDA ES EL MAPA -->
        <div class="col-8">
            <div id="divmapa" class="row-8 justify-content-center">

                <!-- MAPA -->
                <div id="map"></div>

                <!-- ESTILOS DEL MAPA -->
                <style>
                    #map {
                        width: 80%;
                        height: 600px;
                        margin: auto;
                    }
                </style>


                <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
                    integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
                    crossorigin="" />
                <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
                    integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
                    crossorigin=""></script>

                <!-- PARA CENTRAR EL MAPA    -->
                <script src="{% static 'js/center_map.js' %}"></script>
            </div>
        </div>

        <!-- COLUMNA DERECHA ES EL FORMULARIO DE BUSQUEDA -->
        <div class="col-4">
            <form>
                <div class="form-group">
                    <label for="criterio">Criterio de busqueda</label>
                    <select type="email" class="form-control" id="criterio">
                        <option value="">Seleccione el criterio</option>
                        <option value="empresa">Por empresa</option>
                        <option value="ruta">Por ruta</option>
                        <option value="destino">Por destino común</option>
                        <option value="paradas">Por paradas intermedias</option>
                    </select>
                </div>
                <div id="campos" class="form-group">
                    <!-- Aquí se colocan objetos dinámicos según el criterio -->
                </div>
                <button id="buscar" class="btn btn-primary">Buscar</button>
            </form>
        </div>
    </div>
</div>


<!-- LOGICA DE LA PAGINA -->
<script>
    function configurar_mapa() {
        var mymap = L.map('map').setView([51.505, -0.09], 13);
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox.streets'
        }).addTo(mymap);

        center_map(mymap);
    }

    function pedir_rutas(){
        alert("searching data");
    }

    $(document).ready(function () {
        // Configurar funcionamiento dinámico del formulario
        $("#criterio").on("change", criterio_cambiado);
        
        configurar_mapa();

        // Prevenir que el botón buscar envíe el formulario
        // porque los datos se traerán por ajax para renderizar en el mapa 
        $("form").submit(function(e){
            e.preventDefault(e);
        });

        $("#buscar").on("click", pedir_rutas);


    });

    function criterio_cambiado() {
        // Limpiar la zona de campos variables
        $("#campos").empty();

        // Rellenar la zona según el criterio seleccionado
        switch (this.value) {
            case "empresa":
                form_por_empresa();
                break;
            case "ruta":
                form_por_ruta();
                break;
            case "destino":
                form_por_destino();
                break
            case "paradas":
                form_por_paradas();
                break;
        }
    }

    // Agrega un combo con las empresas 
    function form_por_empresa() {

        // Crear el combo
        var combo_empresa = document.createElement("select");
        $(combo_empresa).addClass("form-control");
        var div = document.createElement("div");
        $(div).addClass("form-group");

        // Hacer la peticion para conseguir las empresas
        $.ajax({
            url: "/empresa/listar/meta/",
        }).done(function (data) {
            $(combo_empresa).html(data);
        });

        // Agregar el combo la página
        $("#campos").append(combo_empresa);
    }

    // Agrega un datalist con todas la rutas en su descripcion y empresa
    function form_por_ruta() {

        // Crear la lista opciones 
        var lista = $(document.createElement("datalist"));
        lista.attr("id", "lista_rutas");

        // Crear input y ponerle la referencia a su lista
        var input = $(document.createElement("input"));
        input.attr("list", "lista_rutas");
        input.attr("placeholder", "Buscar...")
        input.append(lista); // agregar la lista dentro del input 

        // Agregar el input a la página 
        $("#campos").append(input);

        // Enviar petición para listar las rutas (opciones)
        $.ajax({
            url: "/ruta/listar/meta/"
        }).done(function (data) {
            // Deserializar la respuesta
            const rutas = JSON.parse(data);

            // Crear un <option> por cada ruta 
            rutas.forEach(function (ruta) {
                var option = $(document.createElement("option"));
                // Lo que se mostrará en pantalla (nombre legible)
                option.html(`${ruta.descripcion} [${ruta.empresa}]`);
                // El valor que se enviará realmente 
                option.attr("value", ruta.id);
                // Agregar la nueva opción a la lista ya existente
                $(lista).append(option);

            });

        });
    }

    // Agregar un mapa a la página para que el usuario pueda delimitar el
    // área de búsqueda deseada 
    function form_por_destino() {
    }

    // Agregar un mapa a la página para que el usuario pueda delimitar el
    // área de búsqueda deseada 
    function form_por_paradas() {
    }
</script>

{% endblock %}